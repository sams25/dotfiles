#!/bin/bash

#
# Script to compile most documents (markdown, latex etc)
#

usage()
{
    script=${0##*/}
    echo
    echo "Usage of ${script}: "
    echo "----------------"
    echo "$script <document> [to_open?]"
    echo "Compiles document using appropriate tool"
    echo "Also opens the output file if the to_open flag was set by typing 'o'"
    echo "----------------"
    echo
    echo "Error: $1"

    exit 1
}


#TODO: make it so that you can run makenotes from any directory, right now it
#      creates the new pdf in the location of execution and opens the file in the
#      subdirectory
# TODO: Write options for specifying output format
# TODO: Pass additional arguments to this script to the underlying tool

fullfile="$1"
to_open="$2"    # Whether or not output should be opened

filetypeout=".pdf"            # TODO: Write options for specifying output format
filetypein="${fullfile##*.}"  # Input extension
file="${fullfile%.*}"         # Just the filename with no extension

READER="xdg-open"
if [ "$file" == "" ] ; then
    usage "No file specified as target"
fi

case "$filetypein" in

    "tex")
        echo 'Regular LaTeX: ' $fullfile
        pdflatex $file
        ;;

    "md")
        echo 'Vanilla Markdown: ' $fullfile
        makeprg="pandoc --pdf-engine=pdflatex -V geometry:margin=1in"
        $makeprg $fullfile -o $file$filetypeout
        ;;

    "pmd")
        echo 'Presentation (Beamer) Markdown: ' $fullfile
        makeprg="pandoc --pdf-engine=pdflatex -t beamer"
        $makeprg $fullfile -o $file$filetypeout
        ;;

    "Rmd")
        echo 'R Markdown: ' $fullfile
        makeprg="Rscript --vanilla -e \"rmarkdown::render('$fullfile', knit_root_dir='$PWD', output_dir='$PWD', clean=TRUE)\""
        eval $makeprg
        ;;

    "adoc")
        echo 'Asciidoc: ' $fullfile
        makeprg="asciidoctor-pdf"
        $makeprg $fullfile
        ;;

    *)
        echo 'Unknown file type, cannot make notes'
        exit 1
        ;;
esac

if [ $? -eq 0 ] && [ "$to_open" ==  "o" ]
then
	$READER "$file$filetypeout"
elif [ "$to_open" != "o" ]
then
	echo -e "\nOpen-file is not set, doing nothing."
else
	echo -e "\nThere was an error in compiling in the file. Output anyway? \(y/*\)"
	read confirm
	if [ "$confirm" == "y" ] || [ "$confirm" == "Y" ]
	then
		$READER "$file$filetypeout"
	fi
fi

echo -e "\nCompleted with status" $?

